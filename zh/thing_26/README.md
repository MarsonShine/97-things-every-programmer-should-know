# 不要忽视错误！

> *一天晚上，我走在街上，准备去酒吧见几个朋友。我们已经有一段时间没有一起喝啤酒了，我很期待再次见到他们。由于匆忙，我没留心脚下。我绊倒在人行道的边缘，摔得鼻青脸肿。好吧，我犯了个错，没留神看路，我猜我是活该吧。*

> 我的腿受伤了，但我急着去见朋友。于是我爬起来继续往前走。走着走着，疼痛越来越厉害。虽然一开始我以为是受了惊吓。但很快我就意识到出了问题

> 但我还是匆匆赶往酒吧。到酒吧时，我已经痛得死去活来了。由于心神不宁，我没有度过一个愉快的夜晚。早上我去看了医生，发现我的胫骨骨折了。如果我在感到疼痛时停下来，我就不会因为走在上面而造成更大的伤害。这可能是我人生中最糟糕的一次晨起。

太多程序员写的代码就像我那灾难性的夜晚。

*错误？什么错误？可能没什么大不了的。我可以忽略它。* 这对于健壮的代码不是一个明智的策略。实际上，这只是纯粹的懒惰（错误的一种）。无论你觉得代码中的错误有多么不可能发生，你都应该始终进行检查，并且始终进行处理。每次都应该如此。如果不这样做，你不会节省时间，反而会为未来积累潜在的问题。

我们通过多种方式报告代码中的错误，包括

- **返回码** 可以用作函数的返回值，表示“它没成功”。错误的返回码很容易被忽略。在代码中你不会看到任何突出显示问题的东西。实际上，忽略某些标准C函数的返回值已经成为标准做法。你有多经常检查printf的返回值？
- **errno** 是一个奇怪的C语言异常，是一个单独的全局变量，用于表示错误。它很容易被忽略，难以使用，并且会导致各种问题——例如，当多个线程调用同一个函数时会发生什么？有些平台会让你免受痛苦的困扰，但其他一些则不会。
- **异常** 是一种更为结构化的语言支持的信号和处理错误的方式。而且你不可能忽略它们。或者你可能吗？我看到过很多这样的代码：

```
try {
    // ...do something...
}
catch (...) {} // 忽略错误
```

这种可怕的结构的好处在于，它突出了你正在做的事情在道德上是可疑的。

如果你忽略错误，视而不见，假装什么都没发生，那么你就会冒很大的风险。就像我的腿最终的状况比我立即停止走路还要糟糕一样，不管不顾地继续前进可能会导致非常复杂的失败。尽早处理问题。做一个简短的记录。

不处理错误会导致

- **脆弱的代码。**充满令人兴奋、难以发现的错误的代码。
- **不安全的代码。** 破解者经常利用错误处理不善的漏洞入侵软件系统。
- **结构不良。** 如果你的代码中存在一些错误，需要不断地处理这些错误，那可能是你的界面不良。如果你的代码中的错误让人难以忍受，那么你的界面可能很糟糕。

正如你应该检查代码中所有潜在的错误一样，你也需要暴露接口中所有潜在的错误条件。不要把它们隐藏起来，假装你的服务总是能正常工作。

我们为什么不检查错误？有很多常见的借口。你同意其中哪些？你会如何反驳？

- 错误处理会扰乱代码的流程，使代码更难阅读，也更难发现“正常”的执行流程。
- 这是额外的工作，而且我的最后期限快到了。
- 我知道这个函数调用*永远不会*返回错误（printf 总是有效，malloc 总是返回新内存——如果它失败了，我们就有更大的问题了......）。
- 这只是一个玩具程序，不需要编写到可用于生产的水平。

作者：[Pete Goodliffe](http://programmer.97things.oreilly.com/wiki/index.php/Pete_Goodliffe)