# 状态思维

现实世界中，人们对状态有着奇怪的关系。今天早上，我顺便去了一下当地的商店，准备再度将咖啡因转化为代码。因为我最喜欢的方式就是喝拿铁咖啡，而且我找不到牛奶，于是我问了售货员。

“抱歉，我们的牛奶已经超级、特大地卖光了。”

对于一个程序员来说，这是一个奇怪的说法。你要么有牛奶，要么没有。在牛奶用完的时候是没有程度可言的。也许她是想告诉我他们的牛奶要卖一个星期才有，但结果对我来说是一样的 — 今天我只能喝浓缩咖啡了。

在大多数现实情况下，人们对状态的这种放松态度通常不是问题。然而，很多程序员对状态也非常模糊 — 这是个问题。

考虑一个只接受信用卡支付且不给客户开发票的简单网店，其中包含一个`Order`类，具有以下方法：

```java
public boolean isComplete() {
    return isPaid() && hasShipped();
}
```

合理，对吧？然而，即使这个表达式已经很好地提取到一个方法中，而不是到处复制粘贴，这个表达式根本不应该存在。它存在的事实突显了一个问题。为什么？因为一个订单在支付之前不能被发货。因此，只有在`isPaid`为真时，`hasShipped`才可能为真，这使得表达式的一部分是多余的。你可能仍然希望在代码中保留`isComplete`以增加代码的清晰度，但是它应该是这样的：

```java
public boolean isComplete() {
    return hasShipped();
}
```

在我的工作中，我经常看到缺少检查和多余检查。这个例子很小，但是当你添加取消和退款时，它会变得更加复杂，对于良好的状态处理的需求也会增加。在这种情况下，一个订单只能处于三种不同的状态之一：

- *进行中：* 可以添加或删除商品。不能发货。
- *已支付：* 不能添加或删除商品。可以发货。
- *已发货：* 完成。不再接受更改。

这些状态非常重要，你需要在执行操作之前检查你是否处于预期的状态，并且你只能从一个合法状态转移到另一个合法状态。简而言之，在正确的位置上，你必须小心地保护你的对象。

但是，你如何开始进行状态思维呢？将表达式提取到有意义的方法中是一个非常好的开始，但这只是一个开始。根本就是要理解状态机。我知道你可能会对计算机科学课程有不好的记忆，但请把它们抛在脑后。状态机并不特别难。通过可视化使它们简单易懂、易于讨论。使用测试驱动的方法来揭示有效和无效的状态和转换，以保持它们正确。学习状态模式。当你感到自信时，深入研究“按约定设计”（Design by Contract）。它帮助你通过在每个公共方法的入口和出口验证传入数据和对象本身来确保有效状态。

如果你的状态不正确，那么就会有 bug，如果你不中止的话，你可能会破坏数据。如果你觉得状态检查很嘈杂，学习如何使用工具、代码生成、织入或者切面来隐藏它们。无论你选择哪种方法，思考状态将使你的代码更简单、更健壮。

作者：[Niclas Nilsson](http://programmer.97things.oreilly.com/wiki/index.php/Niclas_Nilsson)